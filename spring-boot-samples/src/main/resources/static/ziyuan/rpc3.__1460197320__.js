GJ.add("js/util/iframe/rpc3.js",["js/util/event/event_emitter.js","jquery"],function(d,e,c){var f=d("jquery");var h=0;var j=d("js/util/event/event_emitter.js");var i=window.JSON?window.JSON:{stringify:GJ.jsonEncode,parse:GJ.jsonDecode};var g=function(){};var b=function(k){return typeof k==="function"};var a=function(m){var s=this;m=m||{};m.isHost=m.remote?true:false;if(m.isHost){m.channel=GJ.guid("RPC_CHANNEL")}if(window.postMessage||document.postMessage){m.protocol="1"}else{m.protocol="2"}var q={};var n=m.method||{};var k=1;j.mixTo(a.Transport.prototype);var o=new a.Transport(m);var p=function(t){o.send(t)};o.on("ready",function(){if(b(m.onReady)){setTimeout(function(){m.onReady.call(s)},0)}});o.on("message",function(t){if(t.method){l(t)}else{if(t.callbackId){var u=q[t.callbackId];if(u){u(t.result)}}}});var r=function(w,u,v){var t={jsonrpc:"2.0",params:u,method:w,callbackId:k};if(b(u)){v=u}if(b(v)){q[k]=v}k++;setTimeout(function(){p(t)},0)};r.set=function(u,t){n[u]=t};r.destroy=function(){k=0;n={};q={};o.destroy()};function l(w){var t;var v=n[w.method];if(b(v)){try{if(Object.prototype.toString.call(w.params)!=="[object Array]"){w.params=[w.params]}t=v.apply({},w.params)}catch(u){throw new Error("Exec function error: "+u.message)}if(w.callbackId){p({callbackId:w.callbackId,result:t})}}}o.init();r.iframe=m.iframe;return r};a.behavior={};if(c){c.exports=a}(function(k){k.FLAG="__RPC__";k.handleMessage=function(l){return k.FLAG+i.stringify(l)};k.verify=function(m){var l={message:undefined,trust:false};if(m.indexOf(k.FLAG)===0){l.message=m.replace(k.FLAG,"");l.trust=true}return l};k.navigator=function(l,n){var m={incoming:function(o){var p=k.verify(o);if(true===p.trust){o=p.message}else{return}if(o==='"ready"'){n.emit("ready");if(l.isHost){m.outgoing("ready")}}else{n.emit("message",i.parse(o))}},outgoing:function(o){o=k.handleMessage(o);if(l.isHost){window.navigator[l.channel+"_remote"](o)}else{window.navigator[l.channel+"_host"](o)}},init:function(){if(l.isHost){window.navigator[l.channel+"_host"]=m.incoming}else{window.navigator[l.channel+"_remote"]=m.incoming;m.outgoing("ready")}}};return m};k.postMessage=function(m,o){var l;var n={incoming:function(p){if(p.channel===m.channel){o.emit("message",p)}},outgoing:function(p){if(p==="ready"){p={channel:m.channel,isReady:true}}else{p.channel=m.channel}p=k.handleMessage(p);l.postMessage(p,"*")},init:function(){GJ.addEvent(window,"message",function(r){var q=r.data;var s=k.verify(q);if(true===s.trust){q=s.message}else{return}q=i.parse(q);if(q.channel===m.channel){if(q.isReady){if(m.isHost){n.outgoing("ready")}o.emit("ready")}else{n.incoming(q)}}});if(m.isHost){var p=m.iframe;l=("postMessage" in p.contentWindow)?p.contentWindow:p.contentWindow.document}else{l=("postMessage" in window.parent)?window.parent:window.parent.document;n.outgoing("ready")}}};return n}})(a.behavior);(function(k){var m=function(p,o,n){for(var r in o){if(r in p){var q=o[r];if(typeof q==="object"){m(p[r],q,n)}else{if(n){p[r]=o[r]}}}else{p[r]=o[r]}}return p};var l=function(n){var o=null;try{o=document.createElement('<IFRAME name="'+n.channel+'">')}catch(p){}if(!o||o.nodeName!=="IFRAME"){o=document.createElement("IFRAME");o.name=n.channel}n.props=n.props||{};if(typeof n.container==="string"){n.container=document.getElementById(n.container)}m(o.style,n.props.style,true);if(!n.container){m(o.style,{position:"absolute",top:"-2000px",left:"0px"},true)}n.props.src="javascript:false";m(o,n.props,true);o.border=o.frameBorder=0;o.allowTransparency=true;if(n.container){n.container.appendChild(o)}else{n.container=document.body;f("body").prepend(o)}o.src=n.remote;return o};k.Transport=function(p){var o=this,n=[];var q=[];j.mixTo(this);if(!p.isHost){p.channel=window.name}switch(p.protocol){case"1":n=new k.behavior.postMessage(p,o);break;case"2":n=new k.behavior.navigator(p,o);break}p.onLoad=function(){n.init()};this.on("ready",function(){o.send=function(s){n.outgoing(s)};for(var r=0;r<q.length;r++){o.send(q[r])}});this.init=function(){if(p.isHost){p.iframe=l(p)}p.onLoad()};this.send=function(r){q.push(r)};this.destroy=function(){p.iframe.parentNode.removeChild(p.iframe)}}})(a)});