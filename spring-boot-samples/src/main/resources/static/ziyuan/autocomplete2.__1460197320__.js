GJ.add("js/util/autocomplete/autocomplete2.js",["jquery","js/util/event/event_emitter.js","js/util/autocomplete/autocomplete2.css"],function(b,d,a){var e=b("jquery"),j=b("js/util/event/event_emitter.js");j.mixTo(i.prototype);var c=false,f=true,g=window.navigator.userAgent;var h=0;if(/MSIE 6.0/.test(g)){c=true}if(/Macintosh/.test(g)){f=true}function i(k){this.config={resultsClass:"gj_sys_autoc_rs",overClass:"gj_sys_autoc_ov",$input:"",$container:null,maxItemsToShow:10,width:null,left:null,top:null,url:null,data:null,filterHandler:null,defaultDataHandler:null,getDataHandler:null,formatItem:null,noCache:false,selectFirst:false,showTop:false,autoPosition:false};k.url=(typeof k.url==="string"&&k.url.length>0)?k.url:null;k.data=e.isArray(k.data)?k.data:null;k.getDataHandler=e.isFunction(k.getDataHandler)?k.getDataHandler:null;k.defaultDataHandler=e.isFunction(k.defaultDataHandler)?k.defaultDataHandler:null;k.$input=e(k.$input);k.$container=e(k.$container);if(!k.$input.length||(!k.url&&!k.data&&!k.getDataHandler)){throw new Error("Not found input element or source data!")}if(!k.$container.length){k.$container=e("body")}if(k.maxItemsToShow<0){k.maxItemsToShow=10}e.extend(this.config,k);this.init()}i.prototype.init=function(){var k=this;k.$input=k.config.$input;k.$input.attr("autocomplete","off");k.timer=null;k.active=-1;k.hasFocus=false,k.cache={};k.cacheKeys=[];k.$iframeBg=null;if(c){k.$iframeBg=e("<iframe></iframe>");k.$iframeBg.attr({border:0,frameSpacing:0,frameBorder:0,scrolling:"no"}).addClass("gj_sys_autoc_rs_iframe")}k.$resultEl=k.createPanel();k.EventsHandler();if(k.$input.is(":focus")){if(f){k.pollingInputChange=setInterval(function(){k.requestData()},150)}k.showDefaultData();k.hasFocus=false}};i.prototype.createPanel=function(){var l=this.config,k=e("<div class='"+l.resultsClass+"'></div>");l.$container.append(k);if(this.$iframeBg){l.$container.append(this.$iframeBg)}return k};i.prototype.EventsHandler=function(){var k=this,l=this.config;k.$input.keydown(function(m){switch(m.keyCode){case 38:m.preventDefault();k.moveSelect(-1);break;case 40:m.preventDefault();k.moveSelect(1);break;case 13:break;default:if(m.keyCode>8&&m.keyCode<32){return}break}}).keypress(function(m){var n;if(m.keyCode===13&&k.active>-1){m.preventDefault();n=k.$resultEl.find("li:eq("+k.active+")");k.selectItem(n)}}).focus(function(){clearInterval(k.pollingInputChange);if(f){k.pollingInputChange=setInterval(function(){k.requestData()},150)}if(k.config.showResultsOnFocus){k.lastValue=null}else{k.showDefaultData()}k.hasFocus=false}).blur(function(){if(k.hasFocus){return}k.hideResults();clearInterval(k.pollingInputChange)});k.$resultEl.on("mouseenter","li",function(){k.$resultEl.find("li").removeClass(l.overClass);e(this).addClass(l.overClass);k.active=e(this).data("key")}).on("mouseleave","li",function(){k.active=-1;e(this).removeClass(l.overClass)}).on("click","li",function(){k.selectItem(e(this))}).on("mousedown",function(n){n.stopPropagation();k.hasFocus=true;var m=this;e(document).one("mousedown",function(o){if(o.target!==m&&o.target!==k.$input[0]){k.hideResults();k.hasFocus=false}})})};i.prototype.addToCache=function(l,n){var m=this.config;if(m.noCache||!n||!l){return false}if(!this.cache[l]&&this.cacheKeys.length>=10){var o=this.cacheKeys.pop();if(this.cache[o]){delete this.cache[o]}}this.cacheKeys.push(l);this.cache[l]=n};i.prototype.loadFromCache=function(m){var l=this;if(l.cache[m]){return l.cache[m]}return null};i.prototype.selectItem=function(l){if(l.length<1){return false}var k=l.data("data");this.trigger("itemSelect",k,l);if(l.data("data")&&!l.data("data").noHideResults){this.hideResults()}this.lastValue=e.trim(this.config.$input.val())};i.prototype.moveSelect=function(l){if(this.disabled){return false}var s=this.config,r=e("li",this.$resultEl),t=r.size();this.active+=l;if(this.active<-1){this.active=t-1}else{if(this.active===t){this.active=-1}}r.removeClass(s.overClass);var u=e(r[this.active]),o=u.data("key");u.addClass(s.overClass);if(s.maxItemsToShow===0){var p=s.maxItemsToShow>0?s.maxItemsToShow:10,m=u.outerHeight();var k=this.$resultEl.scrollTop();if(o<p){this.$resultEl.scrollTop(0)}else{if(o===t-1){this.$resultEl.scrollTop(9999)}else{if(l<0){m=0-m}this.$resultEl.scrollTop(k+m)}}}var n=this.lastValue,q=this;if(o!==undefined){clearInterval(this.pollingInputChange);n=u.data("data").text}else{q.pollingInputChange=setInterval(function(){q.requestData()},150)}this.$input.val(n);this.trigger("indexChange",o,u.data("data"),u)};i.prototype.showDefaultData=function(){var k=this,l=this.config,m=this.$input.val();m=e.trim(m);if(m||!k.config.defaultDataHandler){k.hideResults()}else{k.isRequesting=false;if(k.loadFromCache("defaultData")){k.receiveData(null,k.loadFromCache("defaultData"));return}k.config.defaultDataHandler(function(n){if(!l.noCache){k.addToCache("defaultData",n)}k.receiveData(null,n)})}};i.prototype.requestData=function(){var k=this,m=this.config,o=m.data,l=m.url;var n=e.trim(k.$input.val());if(f&&n===k.lastValue){return false}k.lastValue=n;k.active=-1;clearTimeout(k.timer);if(!n){k.timer=setTimeout(function(){k.showDefaultData()},150);return false}k.isRequesting=true;if(!o){o=k.loadFromCache(n)}if(o){k.timer=setTimeout(function(){k.isRequesting=false;k.receiveData(n,o)},0)}else{if(l){k.timer=setTimeout(function(){var p=k.$input.attr("name");if(!p){throw new Error("input need name filed!")}var q={signate:new Date().getTime(),name:encodeURIComponent(n)};e.getJSON(l,q,function(r){k.isRequesting=false;k.addToCache(n,r);k.receiveData(n,r)})},150)}else{if(m.getDataHandler){k.timer=setTimeout(function(){m.getDataHandler(n,function(p){if(!p){k.hideResults()}k.isRequesting=false;k.addToCache(n,p);k.receiveData(n,p)})},150)}else{k.hideResults()}}}};i.prototype.receiveData=function(l,k){if(k&&e.isArray(k)&&k.length>0&&!this.isRequesting){this.data=k;if(this.config.filterHandler&&l){k=this.config.filterHandler(l,k)}if(!k.length){this.hideResults();return false}this.$resultEl.empty().append(this.render(l,k));this.showResults(k.length)}else{this.hideResults()}};i.prototype.render=function(o,n){if(n[0]["hideResults"]){h=1}else{h=0}var m=this.config,l=n.length,k=e("<ul></ul>");if((m.maxItemsToShow>0)&&(m.maxItemsToShow<l)){l=m.maxItemsToShow}e.each(n,function(q,r){var p,s=e("<li></li>");if(q>=l){return false}else{p=m.formatItem?m.formatItem(r,o,s,q,n):r[0].replace(new RegExp("("+o+")","i"),'<span class="bold">$1</span>');s.html(p).data("data",r).data("key",q);k.append(s)}});if(m.selectFirst){this.active=0;k.find("li:eq(0)").addClass(m.overClass)}return k};i.prototype.showResults=function(m){var v=this.config;var s,r,p,u,o=this.$input.offset(),l=this.$input.outerHeight(true),t=this.$resultEl.outerHeight(true),q=v.liHeight||this.$resultEl.find("li:eq(0)").outerHeight(true);s=v.left===null?o.left:v.left;r=v.top===null?o.top:v.top;p="auto";u=v.width===null?this.$input.outerWidth()-4:v.width;if(v.maxItemsToShow===0){if(m>10){p=q*10+(v.liHeight?0:6)}else{p="auto"}}else{if(m>v.maxItemsToShow){p=q*v.maxItemsToShow+(v.liHeight?0:6)}else{p="auto"}}if(v.autoPosition){var n=window.innerHeight||document.documentElement.clientHeight;if(r+l+t>n&&r>t){r=r-t}else{r+=l}}else{if(v.showTop){r=r-t}else{r+=l}}var k={height:p,width:u,top:r,left:s};this.disabled=false;this.active=-1;this.$resultEl.css(k).show();this.setIframeBgDisplay(true);this.trigger("showResult",this.$resultEl);if(h===1){this.$resultEl.hide()}};i.prototype.setIframeBgDisplay=function(k){if(this.$iframeBg){if(k){this.$iframeBg.css({width:this.$resultEl.width(),height:this.$resultEl.outerHeight(),left:this.$resultEl.position().left,top:this.$resultEl.position().top}).show()}else{this.$iframeBg.hide()}}};i.prototype.hideResults=function(){var k=this;if(k.timer){clearTimeout(k.timer)}k.lastValue=e.trim(k.$input.val());this.disabled=true;this.$resultEl.hide();this.setIframeBgDisplay(false);k.hide=true;this.trigger("hideResult")};e.fn.autocomplete=function(k){k=k||{};this.each(function(){k.$input=this;new i(k)});return this};a.exports=i});